import { NextRequest, NextResponse } from 'next/server';
export const dynamic = 'force-dynamic';

// Mock vulnerability data generator
function generateVulnerabilityData(state?: string, district?: string) {
    const villages = [];
    const count = district ? 20 : state ? 100 : 500;

    for (let i = 0; i < count; i++) {
        villages.push({
            id: `VILL-${i + 1}`,
            name: `Village ${i + 1}`,
            state: state || 'Jharkhand',
            district: district || 'Ranchi',
            coordinates: {
                lat: 23.3441 + (Math.random() - 0.5) * 0.5,
                lng: 85.3096 + (Math.random() - 0.5) * 0.5,
            },
            waterVulnerability: {
                score: Math.random() * 100,
                level: ['low', 'medium', 'high'][Math.floor(Math.random() * 3)],
                factors: {
                    groundwaterLevel: Math.random() * 100,
                    surfaceWaterAvailability: Math.random() * 100,
                    rainfallVariability: Math.random() * 100,
                    irrigationAccess: Math.random() * 100,
                },
            },
            livelihoodVulnerability: {
                score: Math.random() * 100,
                level: ['low', 'medium', 'high'][Math.floor(Math.random() * 3)],
                factors: {
                    forestDependence: Math.random() * 100,
                    agriculturalProductivity: Math.random() * 100,
                    incomeStability: Math.random() * 100,
                    employmentOpportunities: Math.random() * 100,
                },
            },
            dssPriority: {
                score: Math.random() * 100,
                rank: Math.floor(Math.random() * count) + 1,
                recommendedSchemes: [
                    'JJM',
                    'MGNREGA',
                    'PM-KISAN',
                    'DAJGUA',
                ].filter(() => Math.random() > 0.5),
            },
        });
    }

    return villages;
}

export async function GET(request: NextRequest) {
    const searchParams = request.nextUrl.searchParams;
    const state = searchParams.get('state') || undefined;
    const district = searchParams.get('district') || undefined;
    const vulnerabilityType = searchParams.get('type'); // water, livelihood, or all

    try {
        let data = generateVulnerabilityData(state, district);

        // Filter by vulnerability type if specified
        if (vulnerabilityType === 'water') {
            data = data.filter(v => v.waterVulnerability.level === 'high' || v.waterVulnerability.level === 'medium');
        } else if (vulnerabilityType === 'livelihood') {
            data = data.filter(v => v.livelihoodVulnerability.level === 'high' || v.livelihoodVulnerability.level === 'medium');
        }

        // Generate heatmap data
        const heatmapData = data.map(village => ({
            coordinates: [village.coordinates.lng, village.coordinates.lat],
            waterIntensity: village.waterVulnerability.score,
            livelihoodIntensity: village.livelihoodVulnerability.score,
            dssIntensity: village.dssPriority.score,
        }));

        return NextResponse.json({
            villages: data,
            heatmap: heatmapData,
            summary: {
                total: data.length,
                waterHigh: data.filter(v => v.waterVulnerability.level === 'high').length,
                waterMedium: data.filter(v => v.waterVulnerability.level === 'medium').length,
                waterLow: data.filter(v => v.waterVulnerability.level === 'low').length,
                livelihoodHigh: data.filter(v => v.livelihoodVulnerability.level === 'high').length,
                livelihoodMedium: data.filter(v => v.livelihoodVulnerability.level === 'medium').length,
                livelihoodLow: data.filter(v => v.livelihoodVulnerability.level === 'low').length,
            },
        });
    } catch (error) {
        console.error('Error generating vulnerability data:', error);
        return NextResponse.json(
            { error: 'Failed to generate vulnerability data' },
            { status: 500 }
        );
    }
}
